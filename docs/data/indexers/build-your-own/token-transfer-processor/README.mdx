---
title: Token Transfer Processor
sidebar_position: 0
---

## Overview

The token transfer processor is a [package](https://github.com/stellar/go/tree/ttp-v1.0.0/ingest/processors/token_transfer) which uses the [ingest-sdk](../ingest-sdk/README.mdx) to parse Stellar network transaction data and derive events representing token transfers, mints, burns, clawbacks, and fees.

The token_transfer package consumes Stellar network transaction data and emits [CAP-67, Unified Events](https://stellar.org/protocol/cap-67) which represent all token movements on the network.

## Key Features

- Processes all token movement operations - classic and smart contract:

  - Simple Payments
  - Path payments
  - Account merges
  - Trustline Revocations
  - Claimable balance operations
  - Liquidity pool operations
  - Clawback operations
  - Smart contract events - Stellar Asset Contract events + SEP-41 compliant token events

- Generates standardized events:

  - Transfer: Movement of tokens between accounts
  - Mint: Creation of new tokens
  - Burn: Destruction of tokens
  - Clawback: Asset issuer reclaiming tokens
  - Fee: Network fees paid

- Handles muxed account information for compliance with CAP-67 multiplexing support

- Reconciliation for older protocol versions to ensure consistency between operation changes and generated events

## Event Structure

Token transfer events follow the CAP-67 model and a golang binding to the event model is provided as `TokenTransferEvent` in the `token_transfer` package that is generated from this [proto3 definition](https://github.com/stellar/go/blob/ttp-v1.0.0/protos/ingest/processors/token_transfer/token_transfer_event.proto).

## Chronological Event Ordering

As of protocol 22, events in a ledger follow a specific chronological order:

1. Fee events from all transactions upfront
2. For each transaction:

- Events from each operation within the transaction
- Fee refund for the transaction (if any)

## Smart Contract Events

This processor supports both deriving events from classic operations and parsing smart contract events emitted in the ledger.

For smart contract events, the parsing logic is as follows:

- Check if the smart contract event is a SEP-41 compliant event.
- If yes, attempt to further validate if these are Stellar Asset Contract (SAC) tokens

## Usage

### Creating a Processor

<CodeExample>

`````go
// Create a processor with the network passphrase
processor := token_transfer.NewEventsProcessor(networkPassphrase)

// Optionally disable contract events
processor := token_transfer.NewEventsProcessor(networkPassphrase, token_transfer.DisableContractEvents) ````
`````

</CodeExample>

### Processing a Ledger

<CodeExample>

```go
// Process all events in a ledger
var ledgerCloseMeta xdr.LedgerCloseMeta
...
...
events, err := processor.EventsFromLedger(ledgerCloseMeta)
```

</CodeExample>

### Processing a Transaction

<CodeExample>

```go
// Process events from a transaction
var tx ingest.LedgerTransaction
...
...
txEvents, err := processor.EventsFromTransaction(tx)
// txEvents.FeeEvents contains fee-related events
// txEvents.OperationEvents contains operation-related events
```

</CodeExample>

### Processing an Operation

<CodeExample>

```go
// Process events from a specific operation
var tx ingest.LedgerTransaction
var op xdr.Operation
var opResult xdr.OperationResult
...
...
events, err := processor.EventsFromOperation(tx, opIndex, op, opResult)
```

</CodeExample>

### Event Verification

The package includes functionality to verify the consistency of events with ledger changes:

<CodeExample>

```go
// Verify events for a ledger
err := token_transfer.VerifyEvents(ledgerCloseMeta, networkPassphrase)
```

</CodeExample>

## Implementation Details

The processor handles various special cases:

1. **Minting and Burning**: Determined by checking if the source or destination is the asset issuer
2. **Liquidity Pools**: Specialized handling for pool deposits, withdrawals, and revoked trustlines
3. **Claimable Balances**: Tracks creation, claiming, and clawback operations
4. **Path Payments**: Processes complex paths with multiple asset conversions
5. **Muxed Accounts**: Preserves multiplexed account information in relevant events
6. **Soroban Fees**: Special handling for Soroban transaction fees and refunds

## Event Reconciliation (Legacy Protocol Support)

For ledgers with protocol version less than 8, the processor performs additional reconciliation to ensure consistency between observed balance changes and emitted events. This helps with retroactive event generation for older operations.

## References

- [CAP-67: Unified Events](https://stellar.org/protocol/cap-67)
- [SEP-41: Asset Token Contract Specification](https://stellar.org/protocol/sep-41)
- [CAP-38: Automated Market Makers](https://stellar.org/protocol/cap-38)
- [SEP-35: ID Scheme for Stellar Operations](https://stellar.org/protocol/sep-35)

## Testing

The package includes extensive tests for all supported operations and edge cases. Run tests with:

```bash
go test ./ingest/processors/token_transfer -v
```
